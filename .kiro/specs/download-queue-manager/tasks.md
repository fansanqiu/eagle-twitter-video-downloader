# 实施计划：下载队列管理器

## 概述

本实施计划将 Eagle 视频下载插件从单任务下载转换为多任务队列系统。实施将分阶段进行，首先创建队列管理核心逻辑，然后重构 UI 以支持队列显示，最后集成所有组件并添加测试。

实施策略遵循增量开发原则，每个任务都建立在前一个任务的基础上，确保在每个阶段都有可工作的代码。

## 任务清单

- [x] 1. 创建队列管理器模块
  - [x] 1.1 创建 js/queue.js 并实现核心队列状态管理
    - 定义 queueState 对象结构（items 数组、activeSlots、maxSlots、nextId）
    - 定义 DownloadItem 接口结构（id、url、title、source、format、resolution、fileSize、state、progress、speed、eta、error、timestamp、filePath）
    - 实现 initialize() 函数初始化队列状态
    - 实现 getQueueState() 函数返回当前队列状态
    - _需求：1.1, 1.2, 2.1, 2.4_
  - [x] 1.2 实现队列添加和 ID 生成逻辑
    - 实现 addToQueue(url) 函数创建新的 DownloadItem
    - 为每个新项目分配唯一的自增 ID
    - 将新项目添加到队列数组的开头（最新的在前）
    - 设置初始状态为 'waiting'
    - 调用 processQueue() 尝试启动下载
    - 返回新创建的项目 ID
    - _需求：1.1, 2.4, 3.3_
  - [x] 1.3 实现并发槽位管理
    - 实现 processQueue() 函数检查可用槽位
    - 如果 activeSlots < maxSlots 且有 'waiting' 状态的项目，启动下载
    - 实现 startDownload(itemId) 函数开始单个下载
    - 更新项目状态为 'preparing'
    - 增加 activeSlots 计数
    - 调用 downloader 模块获取元数据和下载视频
    - _需求：8.1, 8.2, 8.3_
  - [x] 1.4 实现状态更新和事件发射
    - 实现 updateItemState(id, updates) 函数更新特定项目
    - 更新项目的 timestamp 字段
    - 实现事件发射机制（使用回调数组）
    - 实现 onStateChange(callback) 函数注册监听器
    - 实现 emitStateChange(item) 函数通知所有监听器
    - _需求：2.5, 3.4_
  - [ ]\* 1.5 为队列管理器编写单元测试
    - 测试队列初始化
    - 测试添加项目到队列
    - 测试唯一 ID 生成
    - 测试槽位限制（最多 3 个并发下载）
    - 测试状态更新和事件发射
    - _需求：1.1, 2.4, 8.1_

- [x] 2. 实现下载处理和进度跟踪
  - [x] 2.1 集成下载器模块与队列管理器
    - 在 startDownload() 中调用 downloader.getVideoInfo() 获取元数据
    - 更新 DownloadItem 的 title、source、format、resolution、fileSize
    - 更新状态为 'downloading'
    - 调用 downloader.downloadVideo() 开始下载
    - 传递进度回调函数到 downloadVideo()
    - _需求：2.2, 2.3_
  - [x] 2.2 实现进度更新处理
    - 实现 handleDownloadProgress(id, progress) 函数
    - 更新项目的 progress、speed、eta 字段
    - 发射状态变更事件以更新 UI
    - 确保进度更新频率至少每 500ms 一次
    - _需求：2.3, 8.4_
  - [x] 2.3 实现下载完成处理
    - 实现 handleDownloadComplete(id, result) 函数
    - 更新项目状态为 'completed'
    - 存储下载的文件路径
    - 减少 activeSlots 计数
    - 调用 Eagle 集成模块导入视频
    - 调用 processQueue() 启动下一个等待的项目
    - _需求：1.3, 8.2, 10.1_
  - [x] 2.4 实现错误处理和重试逻辑
    - 实现 handleDownloadError(id, error) 函数
    - 更新项目状态为 'error'
    - 存储错误消息
    - 减少 activeSlots 计数
    - 调用 processQueue() 启动下一个等待的项目
    - 实现 retryDownload(itemId) 函数重置错误项目
    - 将状态重置为 'waiting'，清除错误和进度
    - _需求：1.4, 9.1, 9.4, 9.5_
  - [ ]\* 2.5 为下载处理编写属性测试
    - **属性 17：并发槽位管理**
    - **验证：需求 8.1, 8.2, 8.3**
  - [ ]\* 2.6 为状态转换编写属性测试
    - **属性 19：状态转换有效性**
    - **验证：需求 1.2, 9.4**

- [x] 3. 检查点 - 确保队列核心逻辑正常工作
  - 确保所有测试通过，如有问题请询问用户。

- [x] 4. 重构 UI 模块以支持队列显示
  - [x] 4.1 在 js/ui.js 中添加队列渲染函数
    - 实现 renderQueueUI() 函数渲染整个队列列表
    - 清空队列容器并为每个项目创建 DOM 元素
    - 实现 renderDownloadItem(item) 函数创建单个项目的 HTML
    - 使用设计文档中的模板结构
    - 应用正确的 CSS 类名
    - _需求：3.1, 4.1, 4.2_
  - [x] 4.2 实现下载项目状态可视化
    - 在 renderDownloadItem() 中根据状态显示不同的 UI
    - 对于 'preparing' 状态：显示 "准备中..." 文本
    - 对于 'downloading' 状态：显示进度条和百分比
    - 对于 'completed' 状态：显示 "完成" 和满进度条
    - 对于 'error' 状态：显示红色错误消息和重试按钮
    - 对于 'waiting' 状态：显示 "等待中..." 文本
    - _需求：4.3, 4.4, 4.5, 4.6, 4.7_
  - [x] 4.3 实现项目更新函数
    - 实现 updateDownloadItem(itemId, item) 函数
    - 查找具有匹配 data-item-id 的 DOM 元素
    - 更新标题、元数据、进度条和状态文本
    - 使用 CSS 过渡实现平滑更新
    - 实现 scrollToTop() 函数滚动到列表顶部
    - _需求：3.4, 11_
  - [x] 4.4 实现输入栏组件
    - 实现 setupInputBar() 函数设置事件监听器
    - 监听输入字段的提交事件
    - 验证 URL 格式（使用现有的 isValidUrl 函数）
    - 实现 clearInputBar() 函数清空输入字段
    - 实现 showInputError(message) 函数显示错误
    - 在输入时清除错误状态
    - _需求：5.1, 5.2, 5.3, 5.4, 5.6_
  - [x] 4.5 实现重试按钮处理
    - 在 renderDownloadItem() 中为错误项目添加重试按钮
    - 为重试按钮添加点击事件监听器
    - 调用 queue.retryDownload(itemId) 重新启动下载
    - _需求：9.3, 9.4_
  - [ ]\* 4.6 为 UI 渲染编写单元测试
    - 测试队列列表渲染
    - 测试单个项目渲染
    - 测试不同状态的可视化
    - 测试项目更新
    - 测试输入验证
    - _需求：3.1, 4.1, 5.2_

- [x] 5. 更新 HTML 和 CSS 以匹配新设计
  - [x] 5.1 重构 index.html 结构
    - 移除旧的单下载 UI 元素（progressContainer、status、locateLink）
    - 添加队列容器 div（id="queueContainer"，class="queue-container"）
    - 添加输入栏 div（class="input-bar"）
    - 在输入栏中添加输入字段（id="urlInput"）和按钮（id="addButton"）
    - 保持 header 结构不变
    - _需求：3.1, 5.1, 6.3_
  - [x] 5.2 添加 CSS 变量和设计系统样式
    - 在 :root 中定义 CSS 变量（--bg1、--bg2、--fg1、--fg2、--brand、--stroke、--error、--success）
    - 使用设计文档中的颜色值
    - 更新现有样式以使用 CSS 变量
    - _需求：7.1, 7.2, 7.3, 7.4, 7.5, 7.6_
  - [x] 5.3 添加队列容器样式
    - 为 .queue-container 添加样式（flex: 1、overflow-y: auto、padding: 12px）
    - 设置 max-height 为 calc(100vh - 48px - 60px)
    - 添加平滑滚动行为
    - _需求：3.2, 3.5, 6.4_
  - [x] 5.4 添加下载项目样式
    - 为 .download-item 添加样式（background: var(--bg2)、border-radius: 10px、padding: 12px）
    - 为 .item-title 添加样式（font-size: 14px、color: var(--fg1)、ellipsis）
    - 为 .item-metadata 添加样式（font-size: 12px、color: var(--fg2)）
    - 为 .progress-bar-container 添加样式（height: 16px、border-radius: 999px）
    - 为 .progress-bar-fill 添加样式（gradient: #3297ff to #4caf50）
    - 为 .progress-text 添加样式（position: absolute、centered、font-size: 10px）
    - 为 .item-retry 添加样式（按钮样式）
    - _需求：4.1, 4.2, 4.3, 7.7_
  - [x] 5.5 添加输入栏样式
    - 为 .input-bar 添加样式（display: flex、gap: 8px、padding: 12px、border-top）
    - 为 #urlInput 添加样式（flex: 1、height: 36px、background: var(--bg2)、border-radius: 8px）
    - 为 #addButton 添加样式（height: 36px、background: var(--brand)、border-radius: 8px）
    - 应用 Inter 字体（如果可用，否则使用系统字体）
    - _需求：5.1, 6.5, 7.8_

- [x] 6. 集成队列管理器与插件入口
  - [x] 6.1 修改 js/plugin.js 以使用队列管理器
    - 导入 queue 模块
    - 在 eagle.onPluginCreate 中调用 queue.initialize()
    - 设置队列状态变更监听器：queue.onStateChange((item) => ui.updateDownloadItem(item.id, item))
    - 调用 ui.setupInputBar() 设置输入栏
    - 调用 ui.renderQueueUI() 渲染初始空队列
    - _需求：1.1, 3.1_
  - [x] 6.2 实现添加到队列的处理函数
    - 创建 handleAddToQueue(url) 函数
    - 验证 URL（使用 ui.isValidUrl）
    - 如果无效，显示错误并返回
    - 调用 queue.addToQueue(url) 添加到队列
    - 调用 ui.clearInputBar() 清空输入
    - 调用 ui.scrollToTop() 滚动到顶部
    - 将此函数连接到输入栏提交事件
    - _需求：5.3, 5.4_
  - [x] 6.3 移除旧的单下载 UI 代码
    - 移除 handleDownload() 函数
    - 移除 performDownload() 函数
    - 移除对旧 UI 元素的引用（progressContainer、status）
    - 保持 initializeBinaries() 函数不变
    - 保持 Eagle 主题和语言检测不变
    - _需求：8.5_
  - [ ]\* 6.4 为插件集成编写集成测试
    - 测试添加单个 URL 并验证下载完成
    - 测试添加多个 URL 并验证并发处理
    - 测试网络错误后的重试
    - 测试 Eagle 重复检测
    - _需求：1.1, 8.1, 9.4, 10.3_

- [x] 7. 更新 manifest.json 窗口尺寸
  - [x] 7.1 修改 manifest.json 中的窗口配置
    - 将 width 从 480 更改为 400
    - 将 height 从 140 更改为 600
    - 保持其他配置不变（resizable: false、frame: false、vibrancy: true）
    - _需求：6.1, 6.2_

- [x] 8. 添加国际化支持
  - [x] 8.1 在 js/i18n.js 中添加新的翻译键
    - 添加队列状态消息的翻译：
      - 'preparing': "准备中..." / "Preparing..."
      - 'waiting': "等待中..." / "Waiting..."
      - 'completed': "完成" / "Complete"
      - 'retry': "重试" / "Retry"
      - 'addToQueue': "添加到队列" / "Add to Queue"
    - 为两种语言（zh_CN 和 en）添加所有翻译
    - _需求：11.2, 11.3, 11.4, 11.5_
  - [x] 8.2 在 UI 函数中应用翻译
    - 在 renderDownloadItem() 中使用 t() 函数翻译状态文本
    - 在 setupInputBar() 中使用 t() 函数翻译按钮文本
    - 在错误消息中使用 t() 函数
    - _需求：11.3, 11.5_

- [x] 9. 实现可选的持久化功能
  - [x] 9.1 在 js/queue.js 中添加持久化函数
    - 实现 saveQueueState() 函数将已完成的项目保存到 localStorage
    - 限制为最近 50 个项目
    - 使用 STORAGE_KEY = 'eagle-video-downloader-queue'
    - 存储版本号、项目数组和时间戳
    - 实现 loadQueueState() 函数从 localStorage 恢复
    - 仅恢复已完成的项目（不自动重启未完成的下载）
    - _需求：12.1, 12.2, 12.3, 12.4_
  - [x] 9.2 在插件关闭时保存状态
    - 在 window.onbeforeunload 或适当的生命周期钩子中调用 saveQueueState()
    - _需求：12.1_
  - [x] 9.3 在插件启动时恢复状态
    - 在 queue.initialize() 中调用 loadQueueState()
    - 将恢复的项目添加到队列状态
    - 渲染恢复的项目
    - _需求：12.2_
  - [ ]\* 9.4 为持久化编写属性测试
    - **属性 27：关闭时持久化保存（可选功能）**
    - **验证：需求 12.1, 12.3**
  - [ ]\* 9.5 为持久化编写属性测试
    - **属性 28：打开时持久化恢复（可选功能）**
    - **验证：需求 12.2, 12.4**

- [ ] 10. 编写核心属性测试
  - [ ]\* 10.1 为队列添加编写属性测试
    - **属性 1：非阻塞队列添加**
    - **验证：需求 1.1, 5.5**
  - [ ]\* 10.2 为状态跟踪编写属性测试
    - **属性 2：独立项目状态跟踪**
    - **验证：需求 1.2**
  - [ ]\* 10.3 为状态持久化编写属性测试
    - **属性 3：完成和错误时的状态持久化**
    - **验证：需求 1.3, 1.4, 9.5**
  - [ ]\* 10.4 为元数据存储编写属性测试
    - **属性 4：完整元数据存储**
    - **验证：需求 2.1, 2.4**
  - [ ]\* 10.5 为元数据保存编写属性测试
    - **属性 5：元数据更新保存**
    - **验证：需求 2.2**
  - [ ]\* 10.6 为进度跟踪编写属性测试
    - **属性 6：进度跟踪完整性**
    - **验证：需求 2.3**
  - [ ]\* 10.7 为唯一 ID 编写属性测试
    - **属性 7：唯一标识符分配**
    - **验证：需求 2.4**
  - [ ]\* 10.8 为时间戳更新编写属性测试
    - **属性 8：状态变更时的时间戳更新**
    - **验证：需求 2.5**

- [ ] 11. 编写 UI 属性测试
  - [ ]\* 11.1 为队列显示编写属性测试
    - **属性 9：完整队列显示**
    - **验证：需求 3.1**
  - [ ]\* 11.2 为显示顺序编写属性测试
    - **属性 10：最新优先显示顺序**
    - **验证：需求 3.3**
  - [ ]\* 11.3 为 UI 更新编写属性测试
    - **属性 11：及时 UI 更新**
    - **验证：需求 3.4**
  - [ ]\* 11.4 为项目渲染编写属性测试
    - **属性 12：完整项目渲染**
    - **验证：需求 4.1, 4.2, 4.3, 4.4**
  - [ ]\* 11.5 为错误显示编写属性测试
    - **属性 13：带重试的错误显示**
    - **验证：需求 4.6, 9.3**
  - [ ]\* 11.6 为 URL 验证编写属性测试
    - **属性 14：URL 验证**
    - **验证：需求 5.2, 5.4**
  - [ ]\* 11.7 为提交行为编写属性测试
    - **属性 15：成功提交行为**
    - **验证：需求 5.3**
  - [ ]\* 11.8 为输入栏可用性编写属性测试
    - **属性 16：下载期间输入栏可用性**
    - **验证：需求 5.5, 1.1**

- [ ] 12. 编写错误处理和 Eagle 集成属性测试
  - [ ]\* 12.1 为进度更新频率编写属性测试
    - **属性 18：进度更新频率**
    - **验证：需求 8.4**
  - [ ]\* 12.2 为错误消息编写属性测试
    - **属性 20：错误消息保存**
    - **验证：需求 9.1, 9.5**
  - [ ]\* 12.3 为重试状态编写属性测试
    - **属性 21：重试状态重置**
    - **验证：需求 9.4**
  - [ ]\* 12.4 为错误隔离编写属性测试
    - **属性 22：错误隔离**
    - **验证：需求 9.5**
  - [ ]\* 12.5 为 Eagle 导入编写属性测试
    - **属性 23：带完整元数据的 Eagle 导入**
    - **验证：需求 10.1, 10.2**
  - [ ]\* 12.6 为重复检测编写属性测试
    - **属性 24：重复检测和重新下载**
    - **验证：需求 10.3**
  - [ ]\* 12.7 为导入错误编写属性测试
    - **属性 25：导入错误处理**
    - **验证：需求 10.4**
  - [ ]\* 12.8 为翻译编写属性测试
    - **属性 26：翻译覆盖**
    - **验证：需求 11.3, 11.4, 11.5**

- [x] 13. 最终检查点 - 端到端测试
  - 确保所有测试通过，如有问题请询问用户。
  - 手动测试完整的下载流程
  - 验证设计系统合规性（颜色、字体、间距）
  - 测试两种语言的翻译
  - 验证 Eagle 集成正常工作

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用特定需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 属性测试应使用 fast-check 库，每个测试至少运行 100 次迭代
- 每个属性测试必须在注释中引用其设计文档属性：`// 功能：download-queue-manager，属性 {N}：{描述}`
